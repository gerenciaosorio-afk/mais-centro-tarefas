{% extends "base.html" %}
{% block content %}

<!-- Cabeçalho com título + Exportar + Nova tarefa -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">
    Tarefas
    {% if status %}
      — {{ 'Pendentes' if status == 'pendente' else 'Concluídas' }}
    {% endif %}
  </h1>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm"
       href="{{ url_for('export_tasks_csv', status=status) }}">
       Exportar CSV
    </a>
    <a class="btn btn-success btn-sm" href="{{ url_for('create_task') }}">+ Nova tarefa</a>
  </div>
</div>

<!-- Filtros -->
<div class="d-flex gap-2 mb-3">
  <a class="btn btn-outline-secondary btn-sm {% if not status %}active{% endif %}" href="{{ url_for('tasks') }}">Todas</a>
  <a class="btn btn-outline-secondary btn-sm {% if status == 'pendente' %}active{% endif %}" href="{{ url_for('tasks', status='pendente') }}">Pendentes</a>
  <a class="btn btn-outline-secondary btn-sm {% if status == 'concluida' %}active{% endif %}" href="{{ url_for('tasks', status='concluida') }}">Concluídas</a>
</div>

{% if tasks|length == 0 %}
  <div class="text-muted">Sem tarefas por aqui ainda.</div>
{% else %}
  <div class="list-group">
    {% for t in tasks %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
          <div class="me-3">
            <div class="d-flex align-items-center gap-2">
              <h2 class="h6 mb-1">{{ t.title }}</h2>
              {% if t.status == 'concluida' %}
                <span class="badge text-bg-success">Concluída</span>
              {% else %}
                <span class="badge text-bg-warning">Pendente</span>
              {% endif %}
              {% if t.due_date %}
                <span class="badge text-bg-light border">Prazo: {{ t.due_date.strftime('%d/%m/%Y') }}</span>
              {% endif %}
            </div>

            {% if t.description %}
              <div class="text-muted small mb-1">{{ t.description }}</div>
            {% endif %}

            <div class="small text-muted">
              Criada por {{ t.created_by.name if t.created_by else '—' }}
              em {{ t.created_at.strftime('%d/%m/%Y %H:%M') }}
              · Atribuída a: {{ t.assigned_to.name if t.assigned_to else '—' }}
            </div>
          </div>

          <div class="text-end">
            {% if current_user.role == 'manager' %}
              {% if t.status == 'pendente' %}
                <form method="post" action="{{ url_for('set_done', task_id=t.id) }}" class="d-inline">
                  <button class="btn btn-sm btn-primary">Marcar como feita</button>
                </form>
              {% else %}
                <form method="post" action="{{ url_for('reopen', task_id=t.id) }}" class="d-inline">
                  <button class="btn btn-sm btn-outline-secondary">Reabrir</button>
                </form>
              {% endif %}
              <form method="post" action="{{ url_for('delete_task', task_id=t.id) }}" class="d-inline" onsubmit="return confirm('Excluir esta tarefa?');">
                <button class="btn btn-sm btn-outline-danger">Excluir</button>
              </form>
            {% else %}
              <span class="badge text-bg-secondary">Somente gerente pode concluir/excluir</span>
            {% endif %}
          </div>
        </div>

        {% if current_user.role == 'manager' %}
          <form method="post" action="{{ url_for('update_observation', task_id=t.id) }}" class="mt-3">
            <label class="form-label small text-muted">Observação (visível a todos)</label>
            <textarea name="observation" class="form-control" rows="2" placeholder="Anote um encaminhamento, detalhe ou decisão...">{{ t.observation or '' }}</textarea>
            <div class="text-end mt-2">
              <button class="btn btn-sm btn-outline-primary">Salvar observação</button>
            </div>
          </form>
        {% elif t.observation %}
          <div class="mt-3">
            <div class="small text-muted">Observação do gerente:</div>
            <div class="border rounded p-2 bg-light">{{ t.observation }}</div>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}
